<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>SFZ Generator mit ZIP Download</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f0f0f0; }
    input, textarea, button { width: 100%; margin-top: 10px; padding: 10px; font-size: 1em; }
    textarea { height: 300px; }
  </style>
</head>
<body>
  <h2>SFZ Generator mit intelligenter Key-Verteilung & Download</h2>

  <label>1. Notennamen pro Oktave (z.B. C, D#, F, G#):</label>
  <input type="text" id="notes" placeholder="C, D#, F, G#">

  <label>2. Anzahl der Oktaven (z.B. 3):</label>
  <input type="number" id="octaves" value="3">

  <label>3. Sample-Dateinamen (Nutze [Note] als Platzhalter):</label>
  <input type="text" id="filenamePattern" placeholder="Piano_[Note].wav" value="Piano_[Note].wav">

  <label>4. Name der SFZ-Datei (ohne .sfz):</label>
  <input type="text" id="sfzName" value="instrument">

  <button onclick="generateAndDownloadSFZ()">SFZ generieren & als ZIP herunterladen</button>

  <label>SFZ Vorschau:</label>
  <textarea id="output" readonly></textarea>

  <script>
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

    function noteToMidi(note, octave) {
      const index = NOTE_NAMES.indexOf(note);
      return index + (octave + 1) * 12;
    }

    function midiToNote(midi) {
      const name = NOTE_NAMES[midi % 12];
      const octave = Math.floor(midi / 12) - 1;
      return `${name}${octave}`;
    }

    function generateSFZContent(noteInput, octaves, pattern) {
      const noteNames = noteInput.split(',').map(n => n.trim());
      let notes = [];

      for (let oct = 0; oct < octaves; oct++) {
        for (let note of noteNames) {
          if (!NOTE_NAMES.includes(note)) {
            alert(`UngÃ¼ltiger Notenname: ${note}`);
            return "";
          }
          let midi = noteToMidi(note, oct);
          notes.push({ note: note, octave: oct, midi: midi });
        }
      }

      notes.sort((a, b) => a.midi - b.midi);

      let result = "";
      for (let i = 0; i < notes.length; i++) {
        const current = notes[i];
        const midi = current.midi;
        let low, high;

        if (i === 0) {
          const next = notes[i + 1];
          const split = Math.floor((next.midi - midi) / 2);
          low = 0;
          high = midi + split;
        } else if (i === notes.length - 1) {
          const prev = notes[i - 1];
          const split = Math.floor((midi - prev.midi) / 2);
          low = midi - split;
          high = 127;
        } else {
          const prev = notes[i - 1];
          const next = notes[i + 1];
          const lowSplit = Math.floor((midi - prev.midi) / 2);
          const highSplit = Math.floor((next.midi - midi) / 2);
          low = midi - lowSplit;
          high = midi + highSplit;
        }

        const noteLabel = `${current.note}${current.octave}`;
        const filename = pattern.replace("[Note]", noteLabel);

        result += `<region>\n`;
        result += `sample=${filename}\n`;
        result += `lokey=${low}\n`;
        result += `hikey=${high}\n`;
        result += `pitch_keycenter=${midi}\n\n`;
      }

      return result.trim();
    }

    function generateAndDownloadSFZ() {
      const notes = document.getElementById("notes").value;
      const octaves = parseInt(document.getElementById("octaves").value);
      const pattern = document.getElementById("filenamePattern").value;
      const sfzName = document.getElementById("sfzName").value || "instrument";

      const sfzContent = generateSFZContent(notes, octaves, pattern);
      document.getElementById("output").value = sfzContent;

      const zip = new JSZip();
      zip.file(`${sfzName}.sfz`, sfzContent);

      zip.generateAsync({ type: "blob" }).then(function (blob) {
        saveAs(blob, `${sfzName}.zip`);
      });
    }
  </script>
</body>
</html>
